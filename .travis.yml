language: node_js
node_js: "16"
branches:
  only:
    - develop
    - main
addons:
  sonarcloud:
    organization: "soundbond"
    token: ${SONAR_TOKEN}

before_deploy:
  - export VERSION=$(node -p -e "require('./package.json').version")
  - export DOCDIR="docs/asciidoc"
  - export DOCFILE="sb"
  - mv "${DOCDIR}/sb.pdf" "${DOCDIR}/${DOCFILE}-${VERSION}.pdf"
  - export DOCUMENTATION="${DOCDIR}/${DOCFILE}-${VERSION}.pdf"
  - echo documentation is ${DOCUMENTATION}
  # Génération du fichier de configuration .env avec les variables d'environnement de Travis.
  - echo -e "DATABASE = "${DB_DATABASE}"\nUSERNAME = "${DB_USERNAME}"\nPASSWORD = "${DB_PASSWORD}"\nHOST = "${DB_HOST}"\nPORT = "${DB_PORT}"\n > .env
deploy:
  provider: releases
  api_key: $GITHUB_TOKEN
  skip_cleanup: true
  file:
    - ${DOCUMENTATION}
  on:
    branch: main
    tags: true
after_deploy:
  - rm ${DOCUMENTATION}
  - rm docs/asciidoc/sb.html
before_script:
  - npm ci #?
  - cd client
  - yarn install
  - cd ../server
  - npm ci
cache:
  directories:
    - client/node_modules
    - server/node_modules
script:
  - cd ..
  - npm run asciidoc
  - rm docs/asciidoc/sb.html
  - cd client
  - npm run build
  - cd ../server
  - npm run
  - npm run coverage
  - rm -r coverage/sonar.xml
  - rm -r coverage/lcov-report
  - rm -r .nyc_output
  - cd ..
  - sonar-scanner
notifications:
  slack: teamsoundbond:t070C9oXt6APmAQ5qrDegxrPcde1bdfe1aed03b66990b290e9b0783789849db6
